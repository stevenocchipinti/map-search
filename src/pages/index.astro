---
import Layout from '../layouts/Layout.astro';
---

<Layout>
	<div class="flex h-full">
		<!-- Sidebar -->
		<aside id="sidebar" class="w-full md:w-80 lg:w-96 bg-white border-r border-gray-200 flex flex-col overflow-hidden md:relative absolute inset-0 z-20 md:z-auto transition-transform md:translate-x-0" data-collapsed="false">
			<!-- Header -->
			<div class="p-4 border-b border-gray-200 flex-shrink-0">
				<div class="flex items-center justify-between mb-4">
					<h1 class="text-xl font-bold text-gray-900">School Finder</h1>
					<button id="toggle-sidebar" class="md:hidden p-2 rounded-lg hover:bg-gray-100" aria-label="Toggle sidebar">
						<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
							<path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
						</svg>
					</button>
				</div>
				
				<!-- Search Form -->
				<div class="space-y-3">
					<!-- Address Input -->
					<div>
						<label for="address" class="sr-only">Address</label>
						<input
							type="text"
							id="address"
							name="address"
							placeholder="Enter suburb, postcode, or address..."
							class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
						/>
					</div>
					
					<!-- Buttons -->
					<div class="flex gap-2">
						<button
							type="button"
							id="search-btn"
							class="flex-1 px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center justify-center gap-2"
						>
							<span>Search</span>
							<svg id="loading-spinner" class="hidden animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
								<circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
								<path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
							</svg>
						</button>
						<button
							type="button"
							id="location-btn"
							class="px-3 py-2 bg-gray-100 text-gray-700 text-sm font-medium rounded-lg hover:bg-gray-200 focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
							title="Use my current location"
						>
							<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
								<path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
							</svg>
						</button>
					</div>
					
					<!-- Sector Filters -->
					<div class="space-y-2">
						<span class="text-xs font-medium text-gray-500 uppercase tracking-wide">School Sectors</span>
						<div class="flex flex-wrap gap-2">
							<label class="flex items-center gap-1.5 cursor-pointer text-sm">
								<input type="checkbox" name="sector" value="Government" checked class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" />
								<span class="w-2.5 h-2.5 rounded-full bg-blue-500"></span>
								<span class="text-gray-700">Government</span>
							</label>
							<label class="flex items-center gap-1.5 cursor-pointer text-sm">
								<input type="checkbox" name="sector" value="Catholic" class="w-4 h-4 text-orange-600 border-gray-300 rounded focus:ring-orange-500" />
								<span class="w-2.5 h-2.5 rounded-full bg-orange-500"></span>
								<span class="text-gray-700">Catholic</span>
							</label>
							<label class="flex items-center gap-1.5 cursor-pointer text-sm">
								<input type="checkbox" name="sector" value="Independent" class="w-4 h-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500" />
								<span class="w-2.5 h-2.5 rounded-full bg-purple-500"></span>
								<span class="text-gray-700">Independent</span>
							</label>
						</div>
					</div>
				</div>
			</div>
			
			<!-- Results Area -->
			<div id="results-container" class="flex-1 overflow-y-auto p-4 space-y-4">
				<!-- Initial State -->
				<div id="initial-state" class="text-center text-gray-500 py-8">
					<svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-3 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
					</svg>
					<p class="text-sm">Enter an address to find nearby schools, train stations, and supermarkets within walking distance.</p>
				</div>
				
				<!-- Card Containers -->
				<div id="cards-container" class="hidden space-y-4">
				<!-- School Card -->
				<div id="school-card-container" class="bg-white border border-gray-200 rounded-lg overflow-hidden">
					<!-- Primary Card -->
					<div id="school-primary-card" class="p-4">
						<div class="flex items-start justify-between gap-4">
							<div class="flex-1">
								<div class="flex items-center gap-2 mb-2">
									<svg id="school-icon" class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C6.5 6.253 3 9.756 3 14s3.5 7.747 9 7.747m0-13c5.5 0 9-3.503 9-7.747m0 0c0-.016 0-.032 0-.048"/></svg>
									<h3 class="text-lg font-semibold text-gray-900">Loading...</h3>
								</div>
								<p class="text-sm text-gray-600 mb-3">‚Äî</p>
								<div class="flex items-center gap-4">
									<div class="flex items-center gap-2 text-gray-500 text-sm">
										<span class="inline-block w-4 h-4">üö∂</span>
										<span>Loading...</span>
									</div>
								</div>
							</div>
							<button class="school-toggle text-blue-600 hover:text-blue-700 font-medium text-sm hidden">
								‚ñº <span class="school-alt-count">0</span>
							</button>
						</div>
					</div>
					
					<!-- Alternatives Toggle -->
					<div id="school-alternatives-toggle" class="hidden border-t border-gray-200 px-4 py-3 hover:bg-gray-50 cursor-pointer transition">
						<button class="text-blue-600 hover:text-blue-700 text-sm font-medium">
							‚ñº View <span class="school-alt-count">0</span> more options
						</button>
					</div>
					
					<!-- Alternatives List -->
					<div id="school-alternatives" class="hidden border-t border-gray-200 max-h-60 overflow-y-auto">
						<!-- Populated by JavaScript -->
					</div>
				</div>
				
				<!-- Station Card -->
				<div id="station-card-container" class="bg-white border border-gray-200 rounded-lg overflow-hidden">
					<div id="station-primary-card" class="p-4">
						<div class="flex items-start justify-between gap-4">
							<div class="flex-1">
								<div class="flex items-center gap-2 mb-2">
									<svg id="station-icon" class="w-6 h-6 text-cyan-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
									<h3 class="text-lg font-semibold text-gray-900">Loading...</h3>
								</div>
								<p class="text-sm text-gray-600 mb-3">Train Station</p>
								<div class="flex items-center gap-4">
									<div class="flex items-center gap-2 text-gray-500 text-sm">
										<span class="inline-block w-4 h-4">üö∂</span>
										<span>Loading...</span>
									</div>
								</div>
							</div>
							<button class="station-toggle text-blue-600 hover:text-blue-700 font-medium text-sm hidden">
								‚ñº <span class="station-alt-count">0</span>
							</button>
						</div>
					</div>
					
					<div id="station-alternatives-toggle" class="hidden border-t border-gray-200 px-4 py-3 hover:bg-gray-50 cursor-pointer transition">
						<button class="text-blue-600 hover:text-blue-700 text-sm font-medium">
							‚ñº View <span class="station-alt-count">0</span> more options
						</button>
					</div>
					
					<div id="station-alternatives" class="hidden border-t border-gray-200 max-h-60 overflow-y-auto">
					</div>
				</div>
					
				<!-- Supermarket Card -->
				<div id="grocery-card-container" class="bg-white border border-gray-200 rounded-lg overflow-hidden">
					<div id="grocery-primary-card" class="p-4">
						<div class="flex items-start justify-between gap-4">
							<div class="flex-1">
								<div class="flex items-center gap-2 mb-2">
									<svg id="grocery-icon" class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a1 1 0 00-1-1H9a1 1 0 00-1 1v4M5 9h14l1 12H4L5 9z"/></svg>
									<h3 class="text-lg font-semibold text-gray-900">Loading...</h3>
								</div>
								<p class="text-sm text-gray-600 mb-3">Supermarket</p>
								<div class="flex items-center gap-4">
									<div class="flex items-center gap-2 text-gray-500 text-sm">
										<span class="inline-block w-4 h-4">üö∂</span>
										<span>Loading...</span>
									</div>
								</div>
							</div>
							<button class="grocery-toggle text-blue-600 hover:text-blue-700 font-medium text-sm hidden">
								‚ñº <span class="grocery-alt-count">0</span>
							</button>
						</div>
					</div>
					
					<div id="grocery-alternatives-toggle" class="hidden border-t border-gray-200 px-4 py-3 hover:bg-gray-50 cursor-pointer transition">
						<button class="text-blue-600 hover:text-blue-700 text-sm font-medium">
							‚ñº View <span class="grocery-alt-count">0</span> more options
						</button>
					</div>
					
					<div id="grocery-alternatives" class="hidden border-t border-gray-200 max-h-60 overflow-y-auto">
					</div>
				</div>
				</div>
				
				<!-- Error Message -->
				<div id="error-message" class="hidden m-4 p-3 bg-red-50 border border-red-200 text-red-700 rounded-lg text-sm"></div>
			</div>
		</aside>
		
		<!-- Mobile Toggle Button -->
		<button id="open-sidebar" class="md:hidden fixed bottom-4 left-4 z-30 p-3 bg-blue-600 text-white rounded-full shadow-lg hover:bg-blue-700 transition-colors">
			<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
			</svg>
		</button>
		
		<!-- Map Container -->
		<div class="flex-1 relative">
			<div id="map" class="absolute inset-0 z-0"></div>
		</div>
	</div>
</Layout>

<style>
	#sidebar[data-collapsed="true"] {
		transform: translateX(-100%);
	}
	
	@media (min-width: 768px) {
		#sidebar[data-collapsed="true"] {
			transform: translateX(0);
		}
	}

	/* Card styles */
	.time-badge {
		display: inline-flex;
		align-items: center;
		gap: 0.5rem;
		padding: 0.5rem 0.75rem;
		border-radius: 0.375rem;
		font-size: 0.875rem;
	}

	.time-badge.estimate {
		background-color: #f3f4f6;
		border: 1px dashed #d1d5db;
		color: #6b7280;
	}

	.time-badge.estimate .label {
		font-size: 0.75rem;
		color: #9ca3af;
		font-weight: 500;
		margin-left: 0.25rem;
	}

	.time-badge.actual {
		background-color: #eff6ff;
		border: 1px solid #bfdbfe;
		color: #1e40af;
		font-weight: 500;
	}

	.distance-badge {
		display: inline-flex;
		align-items: center;
		gap: 0.5rem;
		font-size: 0.875rem;
		color: #6b7280;
	}

	.alternative-item {
		padding: 0.75rem 1rem;
		border-bottom: 1px solid #f3f4f6;
		cursor: pointer;
		transition: background-color 0.15s ease;
	}

	.alternative-item:hover {
		background-color: #f9fafb;
	}

	.alternative-item:last-child {
		border-bottom: none;
	}

	.loading-state {
		display: inline-flex;
		align-items: center;
		gap: 0.5rem;
		color: #9ca3af;
		font-size: 0.875rem;
	}

	.loading-state::after {
		content: '';
		display: inline-block;
		width: 0.5rem;
		height: 0.5rem;
		border-radius: 50%;
		background-color: #d1d5db;
		animation: pulse 1.5s ease-in-out infinite;
	}

	@keyframes pulse {
		0%, 100% {
			opacity: 1;
		}
		50% {
			opacity: 0.5;
		}
	}
</style>

<script>
	// Types
	interface School {
		name: string;
		suburb: string;
		state: string;
		postcode: string;
		sector: 'Government' | 'Catholic' | 'Independent';
		type: string;
		latitude: number;
		longitude: number;
		distance: number;
		walkingTime: number | null;
		walkingPath: GeoJSON.LineString | null;
	}

	interface POI {
		id: string;
		name: string;
		lat: number;
		lng: number;
		type: 'station' | 'grocery';
		distance: number;
		walkingTime: number | null;
		walkingPath: GeoJSON.LineString | null;
	}

	interface SearchResponse {
		userLocation: {
			lat: number;
			lng: number;
			address: string;
		};
		results: {
			schools: School[];
			stations: POI[];
			groceries: POI[];
		};
		errors: {
			schools?: string;
			stations?: string;
			groceries?: string;
		};
	}

	interface CachedRoute {
		walkingTime: number;
		walkingPath: GeoJSON.LineString;
		distance: number;
	}

	// DOM Elements
	const sidebar = document.getElementById('sidebar') as HTMLElement;
	const toggleSidebarBtn = document.getElementById('toggle-sidebar') as HTMLButtonElement;
	const openSidebarBtn = document.getElementById('open-sidebar') as HTMLButtonElement;
	const addressInput = document.getElementById('address') as HTMLInputElement;
	const searchBtn = document.getElementById('search-btn') as HTMLButtonElement;
	const locationBtn = document.getElementById('location-btn') as HTMLButtonElement;
	const loadingSpinner = document.getElementById('loading-spinner') as HTMLElement;
	const errorMessage = document.getElementById('error-message') as HTMLElement;
	const sectorCheckboxes = document.querySelectorAll<HTMLInputElement>('input[name="sector"]');
	const initialState = document.getElementById('initial-state') as HTMLElement;
	const cardsContainer = document.getElementById('cards-container') as HTMLElement;
	
	// Marker colors
	const colors = {
		user: '#ef4444',
		government: '#3b82f6',
		catholic: '#f97316',
		independent: '#a855f7',
		station: '#0891b2', // Cyan/teal color to distinguish from red user marker
		grocery: '#eab308'
	};

	// Initialize map
	const map = L.map('map').setView([-25.2744, 133.7751], 4);
	L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
		attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
	}).addTo(map);

	// State
	let markers: L.Marker[] = [];
	let polylines: Map<string, L.Layer> = new Map();
	let currentResults: SearchResponse | null = null;
	let userLat: number = 0;
	let userLng: number = 0;
	let routeCache: Map<string, CachedRoute> = new Map();

	// Create marker icon
	function createMarkerIcon(color: string, size: number = 12): L.DivIcon {
		return L.divIcon({
			className: 'custom-marker',
			html: `<div style="
				width: ${size}px;
				height: ${size}px;
				background-color: ${color};
				border: 2px solid white;
				border-radius: 50%;
				box-shadow: 0 2px 4px rgba(0,0,0,0.3);
			"></div>`,
			iconSize: [size + 4, size + 4],
			iconAnchor: [(size + 4) / 2, (size + 4) / 2],
			popupAnchor: [0, -(size / 2 + 2)]
		});
	}

	// Get selected sectors
	function getSelectedSectors(): string[] {
		return Array.from(sectorCheckboxes).filter(cb => cb.checked).map(cb => cb.value);
	}

	// Set selected sectors
	function setSelectedSectors(sectors: string[]): void {
		sectorCheckboxes.forEach(cb => { cb.checked = sectors.includes(cb.value); });
	}

	// Toggle sidebar
	function toggleSidebar(show?: boolean): void {
		const isCollapsed = sidebar.dataset.collapsed === 'true';
		const newState = show !== undefined ? !show : !isCollapsed;
		sidebar.dataset.collapsed = String(newState);
		openSidebarBtn.classList.toggle('hidden', !newState);
	}

	// Loading state
	function setLoading(loading: boolean): void {
		searchBtn.disabled = loading;
		locationBtn.disabled = loading;
		loadingSpinner.classList.toggle('hidden', !loading);
	}

	// Clear markers and polylines
	function clearMarkers(): void {
		markers.forEach(marker => marker.remove());
		markers = [];
		polylines.forEach(line => line.remove());
		polylines.clear();
	}

	// Cache key generator
	function getCacheKey(from: { lat: number; lng: number }, to: { lat: number; lng: number }, category: string, itemId: string): string {
		const fromKey = `${Math.round(from.lat * 1000)}-${Math.round(from.lng * 1000)}`;
		const toKey = `${Math.round(to.lat * 1000)}-${Math.round(to.lng * 1000)}`;
		return `${fromKey}-${toKey}-${category}-${itemId}`;
	}

	// Draw walking path on map
	function drawWalkingPath(category: 'school' | 'station' | 'grocery', walkingPath: GeoJSON.LineString): void {
		const polylineKey = `${category}-polyline`;
		// Remove existing polyline if present
		if (polylines.has(polylineKey)) {
			polylines.get(polylineKey)!.remove();
		}
		// Draw new polyline
		const color = category === 'school' ? '#3b82f6' : category === 'station' ? '#0891b2' : '#eab308';
		const line = L.geoJSON(walkingPath, {
			style: {
				color,
				weight: 4,
				opacity: 0.7
			}
		}).addTo(map);
		polylines.set(polylineKey, line);
	}

	// Format time display
	function formatTime(walkingTime: number | null, distance: number, isLoading: boolean = false): string {
		if (isLoading) {
			return '<span class="loading-state">Calculating</span>';
		}
		if (walkingTime !== null) {
			return `<div class="time-badge actual">üö∂ ${walkingTime} min walk</div>`;
		}
		const estimate = Math.round(distance * 1.4 * 60 / 5);
		return `<div class="time-badge estimate">üö∂ ~${estimate} min <span class="label">(estimate)</span></div>`;
	}

	// Format distance
	function formatDistance(distance: number): string {
		return `<div class="distance-badge">üìç ${distance.toFixed(2)} km</div>`;
	}

	// Update primary card
	function updatePrimaryCard(category: 'school' | 'station' | 'grocery', item: School | POI, isLoading: boolean = false): void {
		const cardId = `${category}-primary-card`;
		const card = document.getElementById(cardId) as HTMLElement;
		if (!card) return;

		const title = 'name' in item ? item.name : item.name;
		const details = category === 'school' 
			? `${(item as School).suburb}, ${(item as School).state} ¬∑ ${(item as School).type}`
			: category === 'station' ? 'Train Station' : 'Supermarket';

		const iconColor = category === 'school' 
			? colors[(item as School).sector.toLowerCase() as keyof typeof colors] || colors.government
			: category === 'station' ? colors.station : colors.grocery;

		card.innerHTML = `
			<div class="flex items-start justify-between gap-4">
				<div class="flex-1">
					<div class="flex items-center gap-2 mb-2">
						<div style="width: 24px; height: 24px; background-color: ${iconColor}; border-radius: 4px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;"></div>
						<h3 class="text-lg font-semibold text-gray-900">${title}</h3>
					</div>
					<p class="text-sm text-gray-600 mb-3">${details}</p>
					<div class="flex items-center gap-3">
						${formatTime(item.walkingTime, item.distance, isLoading)}
						${formatDistance(item.distance)}
					</div>
				</div>
				${currentResults && currentResults.results[category === 'school' ? 'schools' : category === 'station' ? 'stations' : 'groceries'].length > 1 
					? `<button class="${category}-toggle text-blue-600 hover:text-blue-700 font-medium text-sm">‚ñº <span class="${category}-alt-count">${currentResults.results[category === 'school' ? 'schools' : category === 'station' ? 'stations' : 'groceries'].length - 1}</span></button>`
					: ''
				}
			</div>
		`;
	}

	// Create alternative item
	function createAlternativeItem(category: 'school' | 'station' | 'grocery', item: School | POI, index: number): HTMLElement {
		const div = document.createElement('div');
		div.className = 'alternative-item';
		
		const title = 'name' in item ? item.name : item.name;
		
		// Build details line based on category
		let details: string;
		if (category === 'school') {
			details = `${(item as School).suburb}, ${(item as School).state}`;
		} else if (category === 'station') {
			details = 'Train Station';
		} else {
			// For groceries, show street and suburb if available
			const grocery = item as POI;
			const detailParts: string[] = [];
			if ((grocery as any).street) detailParts.push((grocery as any).street);
			if ((grocery as any).suburb) detailParts.push((grocery as any).suburb);
			if ((grocery as any).postcode && detailParts.length === 0) detailParts.push((grocery as any).postcode);
			details = detailParts.length > 0 ? detailParts.join(', ') : 'Supermarket';
		}

		div.innerHTML = `
			<div class="flex items-start justify-between gap-2">
				<div class="flex-1 min-w-0">
					<p class="font-medium text-gray-900 truncate">${title}</p>
					<p class="text-xs text-gray-600 truncate">${details}</p>
				</div>
				<div class="text-right flex-shrink-0">
					<p class="text-sm text-gray-600">${item.walkingTime ? `${item.walkingTime} min` : `~${Math.round(item.distance * 1.4 * 60 / 5)} min`}</p>
					<p class="text-xs text-gray-500">${item.distance.toFixed(2)} km</p>
				</div>
			</div>
		`;

		div.addEventListener('click', () => selectAlternative(category, index));
		return div;
	}

	// Select alternative
	async function selectAlternative(category: 'school' | 'station' | 'grocery', index: number): Promise<void> {
		if (!currentResults) return;

		const items = category === 'school' 
			? currentResults.results.schools 
			: category === 'station' ? currentResults.results.stations : currentResults.results.groceries;

		if (index >= items.length) return;

		const item = items[index];
		const cacheKey = getCacheKey({ lat: userLat, lng: userLng }, { lat: item.latitude || item.lat, lng: item.longitude || item.lng }, category, (item as any).name || item.id);

		// Show loading state
		updatePrimaryCard(category, item, true);

		// Check cache first
		if (routeCache.has(cacheKey)) {
			const cached = routeCache.get(cacheKey)!;
			item.walkingTime = cached.walkingTime;
			item.walkingPath = cached.walkingPath;
		} else {
			// Fetch walking data
			try {
				const response = await fetch('/api/walking-routes', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({
						from: { lat: userLat, lng: userLng },
						to: { lat: item.latitude || item.lat, lng: item.longitude || item.lng },
						category,
						itemId: (item as any).name || item.id
					})
				});

				const data = await response.json();
				if (data.walkingTime !== null) {
					item.walkingTime = data.walkingTime;
					item.walkingPath = data.walkingPath;
					routeCache.set(cacheKey, { walkingTime: data.walkingTime, walkingPath: data.walkingPath, distance: data.distance });
				}
			} catch (error) {
				console.error(`Error fetching walking route for ${category}:`, error);
			}
		}

		// Update UI
		updatePrimaryCard(category, item, false);
		
		// Update map polyline
		if (item.walkingPath) {
			drawWalkingPath(category, item.walkingPath);
		}

		// Close alternatives (but keep toggle visible)
		const altContainer = document.getElementById(`${category}-alternatives`) as HTMLElement;
		if (altContainer) {
			altContainer.classList.add('hidden');
		}
	}

	// Fit map to show all relevant results
	function fitMapToResults(data: SearchResponse): void {
		const bounds = L.latLngBounds([]);
		
		// Add user location
		bounds.extend([data.userLocation.lat, data.userLocation.lng]);
		
		// Add first result from each category (the top/nearest ones)
		if (data.results.schools.length > 0) {
			const school = data.results.schools[0];
			bounds.extend([school.latitude, school.longitude]);
		}
		
		if (data.results.stations.length > 0) {
			const station = data.results.stations[0];
			bounds.extend([station.lat, station.lng]);
		}
		
		if (data.results.groceries.length > 0) {
			const grocery = data.results.groceries[0];
			bounds.extend([grocery.lat, grocery.lng]);
		}
		
		// Fit the map to the bounds with padding
		if (bounds.isValid()) {
			map.fitBounds(bounds, {
				padding: [50, 50], // 50px padding on all sides
				maxZoom: 15 // Don't zoom in too close
			});
		}
	}

	// Render results
	async function renderResults(data: SearchResponse): Promise<void> {
		currentResults = data;
		userLat = data.userLocation.lat;
		userLng = data.userLocation.lng;
		clearMarkers();

		// Show cards container
		initialState.classList.add('hidden');
		cardsContainer.classList.remove('hidden');

		// Add user marker
		const userMarker = L.marker([data.userLocation.lat, data.userLocation.lng], { icon: createMarkerIcon(colors.user, 14) });
		userMarker.bindPopup(`<strong>Your Location</strong><br>${data.userLocation.address}`);
		userMarker.addTo(map);
		markers.push(userMarker);

		// Process each category
		const categories = [
			{ type: 'school' as const, items: data.results.schools, color: colors.government },
			{ type: 'station' as const, items: data.results.stations, color: colors.station },
			{ type: 'grocery' as const, items: data.results.groceries, color: colors.grocery }
		];

		for (const category of categories) {
			if (category.items.length === 0) {
				// Show empty state
				renderEmptyCategory(category.type);
				continue;
			}

			// Add markers for all items
			category.items.forEach(item => {
				const markerColor = category.type === 'school' 
					? colors[(item as School).sector?.toLowerCase() as keyof typeof colors] || colors.government
					: category.color;
				
				const marker = L.marker([item.latitude || item.lat, item.longitude || item.lng], { icon: createMarkerIcon(markerColor) });
				marker.addTo(map);
				markers.push(marker);
			});

			// Update primary card
			updatePrimaryCard(category.type, category.items[0]);

			// Draw walking path if already available
			if (category.items[0].walkingPath) {
				drawWalkingPath(category.type, category.items[0].walkingPath);
			}

			// Handle alternatives
			const altContainer = document.getElementById(`${category.type}-alternatives`) as HTMLElement;
			const altToggle = document.getElementById(`${category.type}-alternatives-toggle`) as HTMLElement;

			if (category.items.length > 1) {
				// Populate alternatives
				altContainer.innerHTML = '';
				category.items.slice(1).forEach((item, idx) => {
					altContainer.appendChild(createAlternativeItem(category.type, item, idx + 1));
				});

				// Update the count in the toggle button
				const altCountSpans = document.querySelectorAll(`.${category.type}-alt-count`);
				altCountSpans.forEach(span => {
					span.textContent = String(category.items.length - 1);
				});

				// Show toggle
				altToggle.classList.remove('hidden');
				altToggle.addEventListener('click', () => {
					altContainer.classList.toggle('hidden');
				});
			}
		}

		// Fit map to show user location and top result from each category
		fitMapToResults(data);

		// Start loading walking times for nearest 3
		loadNearestWalkingTimes();
	}

	// Render empty state
	function renderEmptyCategory(category: 'school' | 'station' | 'grocery'): void {
		const title = category === 'school' ? 'Schools' : category === 'station' ? 'Train Stations' : 'Supermarkets';
		const messages = {
			school: "No schools found within walking distance. Try a different location or adjust your search.",
			station: "No train stations nearby. You may be in a remote area.",
			grocery: "No supermarkets found within walking distance. Try expanding your search area."
		};

		const card = document.getElementById(`${category}-card-container`) as HTMLElement;
		const primary = document.getElementById(`${category}-primary-card`) as HTMLElement;
		
		primary.innerHTML = `
			<div class="text-center py-6">
				<p class="text-sm font-medium text-gray-900 mb-1">${title}</p>
				<p class="text-xs text-gray-600">${messages[category]}</p>
			</div>
		`;
	}

	// Load walking times for nearest 3
	async function loadNearestWalkingTimes(): Promise<void> {
		if (!currentResults) return;

		console.log('Starting loadNearestWalkingTimes');

		const toFetch = [
			{ category: 'school' as const, item: currentResults.results.schools[0] },
			{ category: 'station' as const, item: currentResults.results.stations[0] },
			{ category: 'grocery' as const, item: currentResults.results.groceries[0] }
		].filter(item => item.item);

		console.log(`Found ${toFetch.length} items to fetch walking times for`);

		for (const { category, item } of toFetch) {
			console.log(`Fetching walking time for ${category}: ${item.name || item.id}`);
			
			const cacheKey = getCacheKey(
				{ lat: userLat, lng: userLng },
				{ lat: item.latitude || item.lat, lng: item.longitude || item.lng },
				category,
				(item as any).name || item.id
			);

			if (routeCache.has(cacheKey)) {
				console.log(`Cache hit for ${category}`);
				const cached = routeCache.get(cacheKey)!;
				item.walkingTime = cached.walkingTime;
				item.walkingPath = cached.walkingPath;
				updatePrimaryCard(category, item);
				// Draw walking path if available
				if (item.walkingPath) {
					drawWalkingPath(category, item.walkingPath);
				}
				continue;
			}

			try {
				console.log(`Making API request for ${category}`);
				const response = await fetch('/api/walking-routes', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({
						from: { lat: userLat, lng: userLng },
						to: { lat: item.latitude || item.lat, lng: item.longitude || item.lng },
						category,
						itemId: (item as any).name || item.id
					})
				});

				const data = await response.json();
				console.log(`Received response for ${category}:`, data);
				
				if (data.walkingTime !== null) {
					item.walkingTime = data.walkingTime;
					item.walkingPath = data.walkingPath;
					routeCache.set(cacheKey, { walkingTime: data.walkingTime, walkingPath: data.walkingPath, distance: data.distance });
					console.log(`Updated ${category} with walking time: ${data.walkingTime} min`);
				}

				updatePrimaryCard(category, item);

				// Draw polyline if available
				if (item.walkingPath) {
					drawWalkingPath(category, item.walkingPath);
				}
			} catch (error) {
				console.error(`Error loading walking time for ${category}:`, error);
			}

			// Wait 1 second before next request to avoid rate limiting
			console.log(`Waiting 1 second before next request...`);
			await new Promise(resolve => setTimeout(resolve, 1000));
		}
		
		console.log('Finished loadNearestWalkingTimes');
	}

	// Handle search
	async function handleSearch(): Promise<void> {
		const address = addressInput.value.trim();
		const sectors = getSelectedSectors();

		if (!address && !navigator.geolocation) {
			errorMessage.textContent = 'Please enter an address or enable location access.';
			errorMessage.classList.remove('hidden');
			return;
		}

		if (!sectors.length) {
			errorMessage.textContent = 'Please select at least one school sector.';
			errorMessage.classList.remove('hidden');
			return;
		}

		errorMessage.classList.add('hidden');
		setLoading(true);
		toggleSidebar(true);

		try {
			const response = await fetch('/api/search', {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({ address, sectors })
			});

			if (!response.ok) throw new Error('Search failed');

			const data = await response.json();
			renderResults(data);
		} catch (error) {
			errorMessage.textContent = error instanceof Error ? error.message : 'Search failed';
			errorMessage.classList.remove('hidden');
		} finally {
			setLoading(false);
		}
	}

	// Event listeners
	searchBtn.addEventListener('click', handleSearch);
	addressInput.addEventListener('keypress', (e) => {
		if (e.key === 'Enter') handleSearch();
	});

	toggleSidebarBtn.addEventListener('click', () => toggleSidebar());
	openSidebarBtn.addEventListener('click', () => toggleSidebar(false));

	locationBtn.addEventListener('click', () => {
		if (!navigator.geolocation) {
			errorMessage.textContent = 'Geolocation is not supported by your browser.';
			errorMessage.classList.remove('hidden');
			return;
		}

		navigator.geolocation.getCurrentPosition(
			(position) => {
				userLat = position.coords.latitude;
				userLng = position.coords.longitude;
				addressInput.value = `${position.coords.latitude}, ${position.coords.longitude}`;
				handleSearch();
			},
			(error) => {
				errorMessage.textContent = `Location error: ${error.message}`;
				errorMessage.classList.remove('hidden');
			}
		);
	});
</script>
